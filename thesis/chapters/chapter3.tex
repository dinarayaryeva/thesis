\chapter{Mathematical Modelling}
\label{chap:mat}

\chaptermark{Third Chapter Heading}

    \temp{Chapter intro +  motivation}
    Remotely operated vehicles (ROVs) are complex systems that require mathematical models for various purposes, 
    including control system design, simulation, and performance analysis. With accurate mathematical models, 
    ROVs are able to navigate through different underwater terrains and complete control tasks with a good 
    precision. Also, the simulation, based on these models, are suitable to test different work scenarios and 
    detect undesirable ROV's behavior before the physical experiment.   
    
    \temp{SRB}
    The fundamentals of the modelling for marine vehicles were fully described in Fossen \cite{fossen:guidance}.
    Using common assumptions, ROV is treated as a single rigid body with six degrees of freedom (DOF).
    By considering the vehicle as a rigid body, we can simplify the mathematical modeling process while capturing the essential dynamics 
    of the system.

    In order to effectively model rigid bodies, it is crucial to consider their kinematic and dynamic properties.
\section{Notations}

    Before proceeding to theoretical derivations, it is necessary to clarify the notations.
    For the motion with six DOF, six independent coordinates are defined in the coordinate frame: 
    three for translational directions (surge, sway, and heave) and three for rotational directions 
    (roll, pitch, and yaw) as depicted in (Fig. \ref{image:6dof})

    \begin{figure}[H]
        \centering\includegraphics*[width=0.5\textwidth]{6dof}
        \caption{6 DOF of a marine vehicle}
        \label{image:6dof}
    \end{figure}

    The linear position of the body is defined as $r = [r_x, r_y, r_z]^\top$ for translation along xyz axis respectively.
    The orientation can be expressed in terms of Euler angles around corresponding axis, it will eventually lead 
    to the singularity when sway angle is $Â± 90^{\circ}$. 
    The quaternions can resolve this problem by adding redundancy into the representation. 
    The quaternion is defined in scalar-first form as 
    $q = q_0 + q_1\cdot i + q_2\cdot j + q_3\cdot k = [q_0, q_1, q_2, q_3]^\top$

    For each direction, the velocity vectors can be defined separately: 
    $v = [v_x, v_y, v_z]^\top$ for translation along xyz axis and
    $\omega = [\omega_x, \omega_y, \omega_z]^\top$ for rotation around xyz axis respectively.
    The same applies to linear forces $f$ and torques $\tau$.

    To summarize, the notations look like:

    \begin{figure}[H]
    \begin{tabular}{ccc}
        \hline Symbol & Description & Dimensionality\\
        \hline
        $r$ & Linear position vector & $\mathbb{R}^{3}$ \\
        $q$ & Angular position (orientation) vector & $\mathbb{R}^{4}$\\
        $v$ & Linear velocity vector & $\mathbb{R}^{3}$\\
        $\omega$ & Angular velocity vector & $\mathbb{R}^{3}$\\
        $f$ & Vector of linear forces& $\mathbb{R}^{3}$ \\
        $\tau$ & Vector of torques& $\mathbb{R}^{3}$ \\
        \hline
        \end{tabular}
        \caption{Notation}
        \label{table:notation}
    \end{figure}

    For the convenience, it is desirable to define combined vectors of positions, velocities and forces as:
    $\bar{r} = \left[\begin{array}{ll}
        r \\
        q
    \end{array}\right]$, $\bar{v} = \left[\begin{array}{ll}
        v \\
        \omega
    \end{array}\right]$ and $\bar{f} = \left[\begin{array}{ll}
        f \\
        \tau
    \end{array}\right]$

    \temp{Cross product notation}
    In order to manipulate with obtained vectors, it is necessary to define cross product operators.
    For vectors in $\mathbb{R}^{3}$ the cross product is multiplication by skew-symmetric matrix $S(\lambda)$:
    $$
    S(\lambda)=\left[\begin{array}{ccc}
        0 & -\lambda_3 & \lambda_2 \\
        \lambda_3 & 0 & -\lambda_1 \\
        -\lambda_2 & \lambda_1 & 0
    \end{array}\right]
    $$
    While for vectors in $\mathbb{R}^{6}$ $\bar{\times}^*$ is the cross product operator defined as:
    $$
    \bar{v}\bar{\times}^*=\left[\begin{array}{ll}
        S(\omega) & 0_{3 \times 3} \\
        S(v) & S(\omega)
    \end{array}\right]
    $$

\section{Frames of reference}

    In order to derive the kinematics and dynamics of the system, the calculations need to be projected into 
    the same frame of reference. 
    Sometimes several coordinate frames are defined based on the system configuration. 
    
    For ROV, it is reasonable to define two coordinate frames. 
    These frames are the earth-fixed frame, which is inertial with fixed origin, and the body-fixed frame, 
    which is a moving frame attached to the vehicle as depicted in (Fig. \ref{image:frames}). 
    \begin{figure}[H]
        \centering\includegraphics*[width=0.5\textwidth]{frames}
        \caption{The frames}
        \label{image:frames}
    \end{figure}

    The origin of the body-fixed frame usually coincides with the vehicle's center of mass,
     and its axes are chosen along the vehicle's principle axes of inertia.

    The state variables of the rigid body expressed in the body-fixed frame would be 
    denoted by $^B$ and in the earth-fixed frame by $^N$.

\section{Kinematics}

    Kinematics describes the motion of the marine vehicle without considering the forces acting upon it.
    In order to describe kinematic motion of the body, it is necessary to find relation between velocities in two coordinate frames.
    This relation can be represented with linear transformations as:
    $$
    \begin{aligned}
        & \dot{\bar{r}}^N=J(\bar{r}^N) \bar{v}^B \\
        \text{where } & J(\bar{r}^N)=\left[\begin{array}{cc}
        R(\bar{r}^N) & 0_{3 \times 3} \\
        0_{4 \times 3} & T(\bar{r}^N)
        \end{array}\right]
    \end{aligned}
    $$
    The rotational matrix $R$ and the transformation matrix $T$ using quaternions can be expressed as follows:
    $$
    \begin{aligned}
    & R(q)=\left[\begin{array}{ccc}
        1-2\left(q_2^2+q_3^2\right) & 2\left(q_1 q_2-q_3 q_0\right) & 2\left(q_1 q_3+q_2 q_0\right) \\
        2\left(q_1 q_2+q_3 q_0\right) & 1-2\left(q_1^2+q_3^2\right) & 2\left(q_2 q_3-q_1 q_0\right) \\
        2\left(q_1 q_3-q_2 q_0\right) & 2\left(q_2 q_3+q_1 q_0\right) & 1-2\left(q_1^2+q_2^2\right)
        \end{array}\right]\\
    & T(q)=\frac{1}{2}\left[\begin{array}{rrr}
        -q_1 & -q_2 & -q_3 \\
        q_0 & -q_3 & q_2 \\
        q_3 & q_0 & -q_1 \\
        -q_2 & q_1 & q_0
        \end{array}\right]
    \end{aligned}
    $$

\section{Dynamics}

    The Newton-Euler approach is commonly used to describe the dynamics of marine vehicles.
    This approach relates the applied forces and moments to the vehicle's linear and angular accelerations.
    The general equation of motion using the Newton-Euler approach in the body-fixed frame can be written as:
    $$
    M\dot{\bar{v}}^B+\bar{v}^B\bar{\times}^*M\bar{v}^B=\bar{f}^B
    $$
    where $M$ represents the inertia matrix of the rigid body.

    The equation above can be further transformed into standard manipulator equation form:
    $$
     M_B \dot{\bar{v}}^B+C_B(\bar{v}^B) \bar{v}^B
    = \bar{f}^B
    $$
    where
    $M_B \in \mathbb{R}^{6 x 6}$ is the rigid body mass matrix,
    $C_B(\bar{v}^B) \in \mathbb{R}^{6 x 6}$ is the rigid body Coriolis and centripetal forces' matrix.

    Nevertheless, some additional terms should be included in the equation to determine the specifics of the ROVs model. 
    These terms comprise added mass, which represents the inertia of the surrounding fluid, the shift of the 
    center of buoyancy due to changes in trim and heel angles, and damping effects. 
    By incorporating these terms into the manipulator equation derived from the Newton-Euler approach, 
    the model becomes more accurate and reflects the natural behavior of the ROV.    

\subsection{Center of Gravity and Center of Buoyancy}
    
    Due to the robust design of the marine vehicles, the center of buoyancy (COB) is usually aligned with
    the center of mass (COM), but placed higher.
    This shift between centers causes torque acting against the capsizing (Fig. \ref{image:scheme}).
    \begin{figure}[H]
        \centering\includegraphics*[width=0.5\textwidth]{01_srb}
        \caption{The vehicle scheme}
        \label{image:scheme}
    \end{figure}
    
    If we place the origin of the body frame at the center of mass, the mass matrix can be expressed as:
    $$
    M_B=\left[\begin{array}{cc}
        m I_{3 \times 3} & -m S\left(r_G^B\right) \\
        m S\left(r_G^B\right) & I_0
    \end{array}\right]
    $$
    where $r_G^B$ is the vector of the gravity center in the body frame, that is eventually a zero vector.

\subsection{Concept of added mass}

    Since the vehicle moves in a viscous environment, we can not neglect the inertia of the surrounding liquid.
    To compensate added mass effect, it is necessary to add two components into dynamics equation: 
    the added mass and the Coriolis forces acting on the added mass.

    We can define vector of dynamical parameters of our body as:
    $$
    f_{\dot{v}} \triangleq \frac{\partial \bar{f}}{\partial \dot{\bar{v}}}
    $$
    Consequently, the added mass matrix $M_A$ and 
    the Coriolis forces matrix for added mass $C_A(v^B)$
    can be expressed as: 
    $$
    \begin{aligned}
        & M_A=\left[\begin{array}{cc}
            A_{11} & A_{12} \\
            A_{21} & A_{22}
            \end{array}\right]=-\operatorname{diag}\left\{f_{\dot{v}}\right\}, \textrm{where } A_{ij} \in \mathbb{R}^{3 x 3} \\
        & C_A(\bar{v}^B)=\left[\begin{array}{cc}
        0_{3 \times 3} & -S\left(A_{11} v^B+A_{12} \omega^B\right) \\
        -S\left(A_{11} v^B+A_{12} \omega^B\right) & -S\left(A_{21} v^B+A_{22} \omega^B)\right.
        \end{array}\right]
    \end{aligned}
    $$

    The values of dynamical parameters are usually determined
    empirically. Therefore, the error on $M_A$ and $C_A$ can be quite large, and we will not consider
    these matrices in our model implementation for the control design.

\subsection{Hydrodynamic Damping}

    Generally, the dynamics of underwater vehicles can be highly nonlinear and coupled.
    Nevertheless, during the slow non-coupled motion the damping can be approximated to linear and quadratic damping:
    $$\begin{aligned}
        & D(\bar{v}^B)=-K_{lin} - K_{quad}\lvert \bar{v}^B \rvert
    \end{aligned}
    $$

    The appropriate values of damping coefficients for vectors $K_{lin}$ and $K_{quad}$ can be discovered through several experiments.

\subsection{Restoring forces}

    The common sense is to neglect all other forces acting on the vehicle except buoyancy and gravity. 
    Although the motion of the current can also affect the dynamics, it is unpredictable and highly nonlinear, 
    which makes it easier to compensate through control.

    The weight of the body is defined as: $W=m g$, where $m$ is the vehicle's mass and $g$ is the gravity acceleration. 
    The buoyancy force is defined as: $B=\rho g \nabla$, where $\rho$ is the water density and $\nabla$ the volume of fluid displaced by the vehicle. 
    
    By transforming the weight and buoyancy force to the body-fixed frame, we get:
    $$
    f_G\left(\bar{r}^N\right)=R^{\top}\left(\bar{r}^N\right)\left[\begin{array}{l}
    0 \\
    0 \\
    W
    \end{array}\right] \quad f_B\left(\bar{r}^N\right)=-R^{\top}\left(\bar{r}^N\right)\left[\begin{array}{l}
    0 \\
    0 \\
    B
    \end{array}\right]
    $$
    Therefore, overall restoring force and moment vector is defined as:
    $$
    g(\bar{r}^N)=-\left[\begin{array}{c}
    f_G(\bar{r}^N)+f_B(\bar{r}^N) \\
    r_G^B \times f_G(\bar{r}^N)+r_B^B \times f_B(\bar{r}^N)
    \end{array}\right]
    $$
    where $r_B^B$ is the vector of the buoyancy center in the body frame. 

\subsection{Matrix representation}

    The final equation representing the system dynamics is:
    $$
        M \dot{\bar{v}}^B + C(\bar{v}^B) \bar{v}^B+D(\bar{v}^B) \bar{v}^B+g(\bar{r}^N)= \bar{f}^B
    $$
    where $M=M_B+M_A$, $C(\bar{v}^B)=C_B(\bar{v}^B)+C_A(\bar{v}^B)$

\section{Thrusters modelling}

    The force and moment vector produced by the thruster are typically represented 
    by a complex nonlinear function $f(\bar{v}^B, V, u)$, which depends on the 
    vehicle's velocity vector $\bar{v}^B$, the power source voltage $V$, and the 
    control variable $u$. 
    However, expressing such a nonlinear relationship directly can be challenging 
    in practical applications. As a result, some authors propose a simpler approach:
    $$
    \bar{f}^B=T\phi(u)
    $$
    where $T \in \mathbb{R}^{6 x n}$ is the thrust configuration matrix, which maps body torques to truster forces, 
    $\phi(u) \in \mathbb{R}^{n x n}$ is the DC-gain transfer function, which defines relation between
    PWM signal and output force.

    % -> #TODO Affine thruster model tau = Bu where B = T@K

% \section{BlueRov modelling \todo{will be placed in a different chapter?}}

%     \todo{\#TODO Check the coefficients. Fix the simulation.}

%     By the specification of the given thrusters, the dependency between control 
%     PWM signal and thrust is highly nonlinear (Fig. \ref{image:thrust}).
%     \begin{figure}[H]
%         \centering\includegraphics*[width=0.8\textwidth]{thrusters}
%         \caption{}
%         \label{image:thrust}
%     \end{figure}
%     In order to model this relation, the polynomial regression was applied on the normalized test data. 
%     A 5th-order approximation of the developed thrust at 16V voltage will be:
%     $$
%     \phi(u_i) = - 0.22 u_i^5
%     - 0.0135 u_i^4
%     + 1.1 u_i^3
%     + 0.172 u_i^2
%     + 1.327 u_i 
%     + 0.027
%     $$
%     The inverse dependency can be determined in the same way. 
%     The following expression is obtained :
%     $$
%     \hat{\phi}(f_i) = 0.0006 f_i^5 
%     - 0.0004 f_i^4 
%     - 0.02 f_i^3
%     + 0.0006 f_i^2 
%     + 0.56 f_i
%     -0.0334
%     $$
%     \href{https://colab.research.google.com/drive/1XaNNENZPk88yaddOYy01vXtHd8_YwT2m?usp=sharing}{Click for Colab}

\section{Summary}

This chapter provides a comprehensive overview of essential 
concepts and equations crucial for understanding the kinematics and dynamics of ROVs.

\textbf{Notation} \\
ROVs have six degrees of freedom (DOF), which include three for translation and three for rotation.
The use of quaternions to represent orientation helps to avoid singularity issues.

\textbf{Frame of reference} \\
There are two coordinate frames: the earth-fixed frame and the body-fixed frame. 
State variables are denoted by $_B$ in the body-fixed frame and $_N$ in the earth-fixed one.

\textbf{Kinematics} \\
The motion of a marine vehicle, without considering external forces, 
is expressed in terms of velocities for two coordinate frames:
$$
\dot{\bar{r}}^N=J(\bar{r}^N) \bar{v}^B
$$

\textbf{Dynamics} \\
The Newton-Euler approach is used to describe the dynamics of ROV by relating applied 
forces and moments to linear and angular accelerations:
$$
M \dot{\bar{v}}^B + C(\bar{v}^B) \bar{v}^B+D(\bar{v}^B) \bar{v}^B+g(\bar{r}^N)= \bar{f}^B
$$
Additional terms like added mass, center of buoyancy, and damping effects enhance model accuracy.

\textbf{Thruster modelling} \\
The complex relationship between thruster force and control variables 
is simplified using a thrust configuration matrix $T$ and a DC-gain transfer function $\phi(u)$.
$$
\bar{f}^B=T\phi(u)
$$

The mathematical models developed in this chapter lay the foundation for designing control systems. 
By accurately capturing the dynamics and kinematics of ROVs, these models enable precise navigation 
underwater. The next chapter will implement effective control strategies and enhance the 
performance of ROVs in various scenarios.