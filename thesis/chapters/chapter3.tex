\chapter{Mathematical Modelling}
\label{chap:mat}

\chaptermark{Third Chapter Heading}

% chapter intro?

    Remotely operated vehicles (ROVs) are complex systems that require mathematical models for various purposes, 
    including control system design, simulation, and performance analysis. With accurate mathematical models, 
    ROVs are able to navigate through different underwater terrains and complete control tasks with a good 
    precision. Also, the simulation, based on these models, are suitable to test different work scenarios and 
    detect undesirable ROV's behaviour before the physical experiment. \\    
    
    The fundamentals of the modelling for marine vehicles were fully described in Fossen \cite{fossen:guidance}.
    Using common assumptions, ROV is treated as a single rigid body with six degrees of freedom (DOF).
    By considering the vehicle as a rigid body, we can simplify the mathematical modeling process while capturing the essential dynamics 
    of the system. \\

    In order to effectively model rigid bodies, it is crucial to consider their kinematic and dynamic properties.\\

\section{Notations}


    Before proceeding to theoretical derivations, it is necessary to clarify the general notations.
    For the motion with six DOF, six independent coordinates are defined in the coordinate frame: 
    three for translational directions (surge, sway, and heave) and three for rotational directions 
    (roll, pitch, and yaw) as depicted in (Fig. \ref{image:6dof})

    \begin{figure}[H]
        \centering\includegraphics*[width=0.5\textwidth]{6dof}
        \caption{6 DOF of a marine vehicle}
        \label{image:6dof}
    \end{figure}

    The linear position is defined as $r = [r_x, r_y, r_z]^\top$ for translation along xyz axis respectively,
    while orientation can be expressed in terms of Euler angles around corresponding axis. 
    But Euler angles will eventually lead to the singularity 
    when sway angle is $Â± 90^{\circ}$. 
    However, the quaternions can resolve this problem by adding redundancy into the representation. 
    The orientation quaternion is defined in scalar-first form as 
    $q = q_0 + q_1\cdot i + q_2\cdot j + q_3\cdot k = [q_0, q_1, q_2, q_3]^\top$

    For each direction, the velocity vectors can be defined separately: 
    $v = [v_x, v_y, v_z]^\top$ for translation along xyz axis and
    $\omega = [\omega_x, \omega_y, \omega_z]^\top$ for rotation around xyz axis respectively.
    The same applies to linear forces $f$ and torques $\tau$.

    To summarize, the general notations look like:

    \begin{figure}[H]
    \begin{tabular}{ccc}
        \hline Notation & Description & Dimentionality\\
        \hline
        $r$ & Linear position vector & $\in \mathbb{R}^{3}$ \\
        $q$ & Angular position (orientation) vector & $\in \mathbb{R}^{4}$\\
        $v$ & Linear velocity vector & $\in \mathbb{R}^{3}$\\
        $\omega$ & Angular velocity vector & $\in \mathbb{R}^{3}$\\
        $f$ & Vector of linear forces& $\in \mathbb{R}^{3}$ \\
        $\tau$ & Vector of torques& $\in \mathbb{R}^{3}$ \\
        \hline
        \end{tabular}
        \caption{Notation}
        \label{table:notation}
    \end{figure}

    For the convenience, it is desirable to define combined vectors of positions, velocities and forces as:
    $\bar{q} = \left[\begin{array}{ll}
        r \\
        q
    \end{array}\right]$, $\bar{v} = \left[\begin{array}{ll}
        v \\
        \omega
    \end{array}\right]$ and $\bar{f} = \left[\begin{array}{ll}
        f \\
        \tau
    \end{array}\right]$

    In order to manipulate with obtained vectors, it is necessary to define cross product operators:\\
    $S(\lambda)$ is a skew-symmetric matrix defined such that:
    $$
    S(\lambda)=\left[\begin{array}{ccc}
        0 & -\lambda_3 & \lambda_2 \\
        \lambda_3 & 0 & -\lambda_1 \\
        -\lambda_2 & \lambda_1 & 0
    \end{array}\right]
    $$ therefore $S(u)v = u \times v$ for vectors v,u $\in \mathbb{R}^{3}$ \\
    $\bar{\times}^*$ is the $\mathbb{R}^{6}$ cross product operator defined as: \\
    
    $
    \bar{v}\bar{\times}^*=\left[\begin{array}{ll}
        S(\omega) & 0_{3 \times 3} \\
        S(v) & S(\omega)
    \end{array}\right]
    $ where $\bar{v} = \left[\begin{array}{ll}
        v \\
        \omega
    \end{array}\right]$

\section{Frames of reference}

    In order to derive the kinematics and dynamics of the system, the calculations need to be projected into 
    the same frame of reference. 
    Sometimes several coordinate frames are defined based on the system configuration. 
    
    For ROV, it is reasonable to define two coordinate frames. 
    These frames are the earth-fixed frame, which is inertial with fixed origin, and the body-fixed frame, 
    which is a moving frame attached to the vehicle. as depicted in (Fig. \ref{image:frames}). 
    \begin{figure}[H]
        \centering\includegraphics*[width=0.5\textwidth]{frames}
        \caption{The frames}
        \label{image:frames}
    \end{figure}

    The origin of the body-fixed frame usually coincides with the vehicle's center of mass,
     and its axes are chosen along the vehicle's principle axes of inertia.

    In further derivations, the state variables of the rigid body expressed in the body-fixed frame would be noted by $^B$ and in the earth-fixed frame by $^N$.

\section{Kinematics}

    Kinematics describes the motion of the marine vehicle without considering the forces acting upon it.
    In order to describe kinematic motion of the body, it is necessary to find relation between velocities in two coordinate frames.
    This relation can be represented with linear transformations as:
    $$
    \begin{aligned}
        & \dot{\bar{r}}^N=J(\bar{r}^N) \bar{v}^B \\
        \text{where } & J(\bar{r}^N)=\left[\begin{array}{cc}
        R(\bar{r}^N) & 0_{3 \times 3} \\
        0_{3 \times 3} & T(\bar{r}^N)
        \end{array}\right]
    \end{aligned}
    $$
    where the $R$ is the rotational matrix and the $T$ is the transformation matrix. 
    The kinematic equations for the marine vehicle using quaternions can be written as follows:
    $$
    \begin{aligned}
    & R(q)=\left[\begin{array}{ccc}
        1-2\left(q_2^2+q_3^2\right) & 2\left(q_1 q_2-q_3 q_0\right) & 2\left(q_1 q_3+q_2 q_0\right) \\
        2\left(q_1 q_2+q_3 q_0\right) & 1-2\left(q_1^2+q_3^2\right) & 2\left(q_2 q_3-q_1 q_0\right) \\
        2\left(q_1 q_3-q_2 q_0\right) & 2\left(q_2 q_3+q_1 q_0\right) & 1-2\left(q_1^2+q_2^2\right)
        \end{array}\right]\\
    & T(q)=\frac{1}{2}\left[\begin{array}{rrr}
        -q_1 & -q_2 & -q_3 \\
        q_0 & -q_3 & q_2 \\
        q_3 & q_0 & -q_1 \\
        -q_2 & q_1 & q_0
        \end{array}\right]
    \end{aligned}
    $$

\section{Model dynamics}

    The Newton-Euler approach is commonly used to describe the dynamics of marine vehicles.
    This approach relates the applied forces and moments to the vehicle's accelerations and angular accelerations.
    The general equation of motion using the Newton-Euler approach in the body-fixed frame can be written as:
    $$
    M\dot{\bar{v}}^B+\bar{v}^B\bar{\times}^*M\bar{v}^B=\bar{f}^B
    $$
    where $M$ represents the inertia matrix of the rigid body and 
    $\bar{f}$ represents the total force acting on it.\\
    The equation can be transformed into manupulator equation like:
    $$
     M_B \dot{\bar{v}}^B+C_B(\bar{v}^B) \bar{v}^B
    = \bar{f}^B
    $$
    where
    $M_B \in \mathbb{R}^{6 x 6}$ is the rigid body mass matrix,
    $C_B(\bar{v}^B) \in \mathbb{R}^{6 x 6}$ is the rigid body Coriolis and centripetal forces matrix.

    However, additional terms should be included in the equation to determine the specifics of the ROVs model. 
    These terms comprise added mass, which represents the inertia of the surrounding fluid, the shift of the 
    center of buoyancy due to changes in trim and heel angles, and damping effects. 
    By incorporating these terms into the manipulator equation derived from the Newton-Euler approach, 
    the model becomes more accurate and reflects the natural behavior of the ROV.    

\subsection{Center of Gravity and Center of Buyonancy}
    
    Due to the robust design of the marine vehicles, the center of byonancy(COB) is usually alligned with
    the center of mass(COM), but placed higher.
    This shift between centers causes torque acting against the capsize (Fig. \ref{image:scheme}).\\
    \begin{figure}[H]
        \centering\includegraphics*[width=0.5\textwidth]{01_srb}
        \caption{The vehicle scheme}
        \label{image:scheme}
    \end{figure}
    
    If we place the origin of the body frame at the center of mass(COM), the mass matrix can be expressed as:\\
    $$
    M_B=\left[\begin{array}{cc}
        m I_{3 \times 3} & -m S\left(r_G^B\right) \\
        m S\left(r_G^B\right) & I_0
    \end{array}\right]
    $$
    where $r_G^B$ is the vector of the gravity center in the body frame, that is eventually zero vector.\\
    The same applies to the Coriolis matrix:
    $$
    C_B(\bar{v}^B) =\left[\begin{array}{cc}
        S(\omega^B) & 0_{3 \times 3} \\
        S(v^B) & S(\omega^B)
    \end{array}\right]\times M_B
    $$
\subsection{Concept of added mass}

    Since the vehicle moves in a viscous enviroment, we can not neglect the inertia of the surrounging liquid.
    To compensate added mass effect, it is necessary to add two components into dynamics equation.\\
    We can define vector of dynamical parameters of our body as:
    $$
    f_{\dot{v}} \triangleq \frac{\partial \bar{f}}{\partial \dot{\bar{v}}}
    $$
    Consequently the added mass matrix $M_A$ and 
    the Coriolis forces matrix for added mass $C_A(v^B)$
    can be expressed as: 
    $$
    \begin{aligned}
        & M_A=\left[\begin{array}{cc}
            A_{11} & A_{12} \\
            A_{21} & A_{22}
            \end{array}\right]=-\operatorname{diag}\left\{f_{\dot{v}}\right\}, \textrm{where } A_{ij} \in \mathbb{R}^{3 x 3} \\
        & C_A(\bar{v}^B)=\left[\begin{array}{cc}
        0_{3 \times 3} & -S\left(A_{11} v^B+A_{12} \omega^B\right) \\
        -S\left(A_{11} v^B+A_{12} \omega^B\right) & -S\left(A_{21} v^B+A_{22} \omega^B)\right.
        \end{array}\right]
    \end{aligned}
    $$

    The values of dynamical parameters are usually determined
    empirically. The error on $M_A$ and $C_A$ can be quite large and we will not consider
    these matrices in the model for the control.

\subsection{Hydrodynamic Damping}

    Generally, the dynamics of underwater vehicles can be highly nonlinear and coupled.
    Nevertheless, during the slow non-coupled motion the damping can be approximated to linear and quadratic damping:
    $$\begin{aligned}
        & D(\bar{v}^B)=-K_{lin} - K_{quad}\lvert \bar{v}^B \rvert
    \end{aligned}
    $$

    The appropriate values of damping coefficients for vectors $K_{lin}$ and $K_{quad}$ can be discovered through several experiments.

\subsection{Restoring forces}

    The common sense is to neglect all other forces acting on the vehicle except buoyancy and gravity. 
    Although the motion of the current can also affect the dynamics, it is unpredictable and highly nonlinear, 
    which makes it easier to compensate through control.\\
    The weight of the body is defined as: $W=m g$, where $m$ is the vehicle's mass and $g$ is the gravity acceleration. 
    The buoyancy force is defined as: $B=\rho g \nabla$, where $\rho$ is the water density and $\nabla$ the volume of fluid displaced by the vehicle. 
    
    By transforming the weight and buoyancy force to the body-fixed frame, we get:

    $$
    f_G\left(\bar{r}^N\right)=R^{\top}\left(\bar{r}^N\right)\left[\begin{array}{l}
    0 \\
    0 \\
    W
    \end{array}\right] \quad f_B\left(\bar{r}^N\right)=-R^{\top}\left(\bar{r}^N\right)\left[\begin{array}{l}
    0 \\
    0 \\
    B
    \end{array}\right]
    $$
    Therefore, overall restoring force and moment vector is defined as:
    $$
    g(\bar{r}^N)=-\left[\begin{array}{c}
    f_G(\bar{r}^N)+f_B(\bar{r}^N) \\
    r_G^B \times f_G(\bar{r}^N)+r_B^B \times f_B(\bar{r}^N)
    \end{array}\right]
    $$
    where $r_B^B$ is the vector of the buoyancy center in the body frame. 

\subsection{Matrix representation}

    The final system of equations for the mathematical model is:
    $$
    \begin{cases}
    & M \dot{\bar{v}}^B + C(\bar{v}^B) \bar{v}^B+D(\bar{v}^B) \bar{v}^B+g(\bar{r}^N)= \bar{f}^B\\
    & \dot{\bar{r}}^N=J(\bar{r}^N) \bar{v}^B
    \end{cases}
    $$
    where
    $M=M_B+M_A$, $C(\bar{v}^B)=C_B(\bar{v}^B)+C_A(\bar{v}^B)$

\section{Thrusters modelling}

    In the general case, the thruster force and moment vector will be 
    a complicated function depending on the vehicle's velocity vector $\bar{v}^B$, 
    voltage of the power source V 
    and the control variable $u$.
    This relationship can be expressed as:
    $$
    \bar{f}^B=T\phi(u)
    $$
    where $T \in \mathbb{R}^{6 x n}$ is the thrust configuration matrix that maps body torques to thuster forces, 
    $\phi(u) \in \mathbb{R}^{n x n}$ is the DC-gain transfer function that defines relation between
    PWM signal and output force, where n - number of thrusters.

\section{BlueRov modelling (will be placed in a different chapter (?))}

    By the specification of the given thrusters, the dependency between control 
    PWM signal and thrust is highly nonlinear
    (Fig. \ref{image:thrust}).\\
    \begin{figure}[H]
        \centering\includegraphics*[width=0.8\textwidth]{thrusters}
        \caption{}
        \label{image:thrust}
    \end{figure}
    In order to model this relation, the polynomial regression was applied on the normalized test data. 
    A 5th-order approximation of the developed thrust at 16V voltage will be:
    $$
    \phi(u_i) = - 0.22 u_i^5
    - 0.0135 u_i^4
    + 1.1 u_i^3
    + 0.172 u_i^2
    + 1.327 u_i 
    + 0.027
    $$
    The inverse dependency can be determined in the same way. 
    The following expression is obtained :
    $$
    \hat{\phi}(f_i) = 0.0006 f_i^5 
    - 0.0004 f_i^4 
    - 0.02 f_i^3
    + 0.0006 f_i^2 
    + 0.56 f_i
    -0.0334
    $$
    \href{https://colab.research.google.com/drive/1XaNNENZPk88yaddOYy01vXtHd8_YwT2m?usp=sharing}{Click for Colab}